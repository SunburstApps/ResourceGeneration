<Project>
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
    <AutoGenerateRestextCodeBehindFiles Condition="'$(AutoGenerateRestextCodeBehindFiles)' == ''">true</AutoGenerateRestextCodeBehindFiles>
    <ResourceGenerationTasksAssembly>$(MSBuildThisFileDirectory)/netstandard2.0/Sunburst.ResourceGeneration.dll</ResourceGenerationTasksAssembly>
    <EnableDefaultRestextItems Condition="'$(EnableDefaultRestextItems)' == ''">true</EnableDefaultRestextItems>
  </PropertyGroup>

  <ItemGroup Condition="'$(EnableDefaultItems)' == 'true' and '$(EnableDefaultRestextItems)' == 'true'">
    <None Remove="**/*.restext" Condition="'$(EnableDefaultNoneItems)' == 'true'" />
    <EmbeddedResource Include="**/*.restext" Exclude="$(DefaultItemExcludes);$(DefaultExcludesInProjectFolder)">
      <Type>Resx</Type>
      <Generator>MSBuild:CompileRestextCodeBehind</Generator>
    </EmbeddedResource>
  </ItemGroup>
  
  <UsingTask TaskName="ComputeRestextCodeBehindFilePath" AssemblyFile="$(ResourceGenerationTasksAssembly)" />
  <UsingTask TaskName="GenerateRestextCodeBehindFile" AssemblyFile="$(ResourceGenerationTasksAssembly)" />

  <Target Name="_ComputeRestextCodeBehindFilePaths" DependsOnTargets="CreateManifestResourceNames">
    <ComputeRestextCodeBehindFilePath EmbeddedResources="@(EmbeddedResource)"
                                      IntermediateOutputPath="$(IntermediateOutputPath)"
                                      Language="$(Language)"
                                      AutoGenerateByDefault="$(AutoGenerateRestextCodeBehindFiles)">
      <Output TaskParameter="RestextFilesWithCodeBehindPath" ItemName="_RestextFileToGenerateCodeBehind" />
    </ComputeRestextCodeBehindFilePath>
  </Target>

  <Target Name="GenerateRestextCodeBehind"
          Condition="'$(DesignTimeBuild)' == ''"
          DependsOnTargets="_ComputeRestextCodeBehindFilePaths;CreateManifestResourceNames"
          Inputs="@(_RestextFileToGenerateCodeBehind)"
          Outputs="@(_RestextFileToGenerateCodeBehind -> '%(CodeBehindFile)')">
    <GenerateRestextCodeBehindFile RestextFiles="@(_RestextFileToGenerateCodeBehind)" Language="$(Language)">
      <Output TaskParameter="Compile" ItemName="FileWrites" />
    </GenerateRestextCodeBehindFile>
  </Target>

  <Target Name="CompileRestextCodeBehind" BeforeTargets="BeforeCompile"
          Condition="'$(_AddedRestextCodeBehindsToCompile)' == ''"
          DependsOnTargets="_ComputeRestextCodeBehindFilePaths;GenerateRestextCodeBehind">
    <ItemGroup>
      <Compile Include="@(_RestextFileToGenerateCodeBehind -> '%(CodeBehindFile)')" />
    </ItemGroup>

    <PropertyGroup>
      <_AddedRestextCodeBehindsToCompile>true</_AddedRestextCodeBehindsToCompile>
    </PropertyGroup>
  </Target>

  <PropertyGroup>
    <CompileDependsOn>
      CompileRestextCodeBehind;
      $(CompileDependsOn)
    </CompileDependsOn>
  </PropertyGroup>
</Project>
